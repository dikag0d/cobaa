name: ðŸ³ Docker Build & Test

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # â”€â”€ Job 1: Build & Test via Docker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docker-test:
    name: Build & Test Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”¨ Build Docker image
        run: |
          docker build -t cobaa-app:test .
          echo "âœ… Docker image built successfully"

      - name: ðŸš€ Start app container
        run: |
          docker run -d \
            --name test-app \
            -p 3000:3000 \
            --health-cmd="wget --no-verbose --tries=1 --spider http://localhost:3000/health || exit 1" \
            --health-interval=5s \
            --health-timeout=3s \
            --health-retries=5 \
            --health-start-period=10s \
            cobaa-app:test

      - name: â³ Wait for container to be healthy
        run: |
          echo "Waiting for container to be healthy..."
          for i in $(seq 1 30); do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' test-app 2>/dev/null || echo "starting")
            echo "  Attempt $i/30: status=$STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "âœ… Container is healthy!"
              exit 0
            fi
            sleep 2
          done
          echo "âŒ Container failed to become healthy"
          docker logs test-app
          exit 1

      - name: ðŸ§ª Run tests
        run: |
          docker run --rm \
            --network host \
            -e TEST_URL=http://localhost:3000 \
            cobaa-app:test \
            node test.js

      - name: ðŸ“‹ Show container logs
        if: always()
        run: docker logs test-app 2>&1 || true

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker stop test-app 2>/dev/null || true
          docker rm test-app 2>/dev/null || true

  # â”€â”€ Job 2: Docker Compose test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  compose-test:
    name: Docker Compose Test
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Build & run with Docker Compose
        run: |
          docker compose up -d --build web
          echo "âœ… docker compose up successful"

      - name: â³ Wait for service to be healthy
        run: |
          echo "Waiting for web service..."
          for i in $(seq 1 30); do
            STATUS=$(docker compose ps web --format json | jq -r '.Health' 2>/dev/null || echo "starting")
            echo "  Attempt $i/30: status=$STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "âœ… Service is healthy!"
              exit 0
            fi
            sleep 2
          done
          echo "âŒ Service failed to become healthy"
          docker compose logs web
          exit 1

      - name: ðŸ§ª Run test via Docker Compose
        run: |
          docker compose --profile test run --rm test
          echo "âœ… Tests passed!"

      - name: ðŸ“‹ Show logs
        if: always()
        run: docker compose logs 2>&1 || true

      - name: ðŸ§¹ Cleanup
        if: always()
        run: docker compose down -v --remove-orphans 2>/dev/null || true
